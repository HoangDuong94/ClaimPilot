<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:l="sap.ui.layout"
    xmlns:html="http://www.w3.org/1999/xhtml">

    <VBox width="100%" height="100%" class="cpChatSidePanel" renderType="Bare">
        <Toolbar>
            <Title text="PureAI"/>
            <ToolbarSpacer/>
            <Button
                icon="sap-icon://delete"
                type="Transparent"
                tooltip="Chatverlauf löschen"
                enabled="{= ${chat>/chatHistory}.length > 0 || ${chat>/isStreaming} }"
                press="onClearChat"/>
            <Button
                icon="sap-icon://stop"
                type="Transparent"
                tooltip="Streaming stoppen"
                visible="{chat>/isStreaming}"
                press="onStopStreaming"/>
        </Toolbar>

        <Text
            text="{chat>/statusMessage}"
            visible="{= !!${chat>/statusMessage} }"
            class="cp-status-message"
            wrapping="true"/>

        <ScrollContainer id="chatHistoryScrollContainerInSidePanel" width="100%" height="100%" vertical="true">
            <VBox width="100%" class="cp-chat-container">
                <List
                    id="chatHistoryList"
                    items="{chat>/chatHistory}"
                    width="100%"
                    inset="false"
                    showSeparators="None"
                    showNoData="false">
                    <CustomListItem>
                        <HBox width="100%"
                             justifyContent="{= ${chat>type} === 'user' ? 'End' : 'Start'}"
                             alignItems="Start"
                             class="{= ${chat>groupStart} ? 'cp-bubble-wrapper cp-group-start' : 'cp-bubble-wrapper'}">
                            <!-- User bubble (fixed classes) -->
                            <VBox class="cp-bubble cp-user" renderType="Bare" visible="{= ${chat>type} === 'user' }">
                                <FormattedText htmlText="{chat>text}"/>
                            </VBox>
                            <!-- Assistant bubble (fixed classes) -->
                            <VBox class="{= ${chat>loading} ? 'cp-bubble cp-assistant cp-bubble-loading' : 'cp-bubble cp-assistant'}" renderType="Bare" visible="{= ${chat>type} !== 'user' }">
                                <HBox class="cp-bubble-loader" visible="{chat>loading}" alignItems="Center" justifyContent="Start">
                                    <Text text="PureAI denkt ..." class="cp-loader-label"/>
                                    <HBox class="cp-loader-dots" alignItems="Center" justifyContent="Start">
                                        <Text text="•" class="cp-loader-dot cp-loader-dot-1"/>
                                        <Text text="•" class="cp-loader-dot cp-loader-dot-2"/>
                                        <Text text="•" class="cp-loader-dot cp-loader-dot-3"/>
                                    </HBox>
                                </HBox>
                                <FormattedText htmlText="{chat>text}" visible="{= !${chat>loading}}"/>
                            </VBox>
                            <Button
                                icon="sap-icon://copy"
                                type="Transparent"
                                tooltip="Text kopieren"
                                visible="{= ${chat>type} !== 'user' }"
                                press="onCopyMessage"
                                class="cp-bubble-actions"/>
                        </HBox>
                    </CustomListItem>
                </List>
            </VBox>
        </ScrollContainer>

        <HBox class="modernInputRow" alignItems="End">
            <VBox width="100%">
                <TextArea
                    id="chatInputField"
                    value="{chat>/userInput}"
                    placeholder="Nachricht an PureAI..."
                    rows="3"
                    width="100%"
                    growing="true"
                    growingMaxLines="6"
                    liveChange="onInputLiveChange"/>
            </VBox>
            <Button
                id="sendButton"
                icon="sap-icon://paper-plane"
                type="Emphasized"
                enabled="{= !${chat>/isStreaming} }"
                press="onSendChatMessageInSidePanel"/>
        </HBox>

        <dependents>
            <Popover
                id="mentionPopover"
                class="cpMentionPopover"
                placement="Auto"
                showHeader="false"
                showArrow="false"
                contentWidth="28rem"
                horizontalScrolling="false"
                afterClose="onMentionPopoverClosed">
                <List
                    id="mentionList"
                    mode="SingleSelectMaster"
                    includeItemInSelection="true"
                    itemPress="onMentionListItemPress"
                    items="{chat>/suggestions}">
                    <items>
                        <CustomListItem type="Active" press="onMentionItemPress">
                            <VBox width="100%" class="cpMentionItem">
                                <Text text="{chat>text}" wrapping="true" class="cpMentionItemText"/>
                            </VBox>
                        </CustomListItem>
                    </items>
                </List>
            </Popover>
        </dependents>
    </VBox>

</core:FragmentDefinition>
